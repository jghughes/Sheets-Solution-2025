<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body {
            font-family: Roboto, Arial, sans-serif;
            margin: 12px;
        }

        h3 {
            margin: 0 0 8px 0;
            font-weight: 500;
        }

        .row {
            display: flex;
            gap: 8px;
            margin: 8px 0;
            align-items: center;
        }

        select, input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .input-error {
            border: 2px solid #b00020 !important;
            animation: shake 0.2s 2;
        }

        @keyframes shake {
            0% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-4px);
            }

            50% {
                transform: translateX(4px);
            }

            75% {
                transform: translateX(-4px);
            }

            100% {
                transform: translateX(0);
            }
        }

        button {
            padding: 10px;
            font-size: 14px;
            border: 0;
            background: #1a73e8;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }

            button.secondary {
                background: #e8eaf6;
                color: #1a237e;
                border: none;
            }

            button:disabled {
                opacity: 0.6;
                cursor: default;
            }

        .note {
            font-size: 12px;
            color: #555;
            margin-top: 8px;
        }

        .small {
            font-size: 12px;
            color: #666;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            background: transparent;
        }

        .status__text {
            flex: 1;
            font-size: 12px;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.25em * 3);
        }

        .status__close {
            display: none;
            padding: 2px 6px;
            font-size: 12px;
            line-height: 1;
            border: 0;
            background: transparent;
            color: inherit;
            cursor: pointer;
            border-radius: 3px;
        }

        .status__detailsLink {
            display: none;
            padding: 2px 6px;
            font-size: 12px;
            line-height: 1;
            border: 0;
            background: transparent;
            color: #1a73e8;
            cursor: pointer;
        }

        .status--error {
            color: #b00020;
            background: rgba(176, 0, 32, 0.04);
        }

        .status--ok {
            color: #2e7d32;
            background: rgba(46, 125, 50, 0.04);
        }

        .status__details {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            background: #f7f7fb;
            border: 1px solid #ececec;
            font-size: 12px;
            display: none;
            gap: 8px;
            flex-direction: column;
        }

            .status__details pre {
                margin: 0;
                padding: 8px;
                background: #fff;
                border-radius: 4px;
                border: 1px solid #e5e5e5;
                max-height: 120px;
                overflow: auto;
                white-space: pre-wrap;
                word-break: break-word;
                font-family: inherit;
                font-size: 12px;
            }

            .status__details .actions {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
            }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0,0,0,0.08);
            border-top-color: white;
            border-radius: 50%;
            box-sizing: border-box;
            display: inline-block;
            vertical-align: middle;
            margin-left: 6px;
            transform: translateY(-1px);
            animation: spin 1s linear infinite;
            visibility: hidden;
        }

        .spinner--visible {
            visibility: visible;
            border-top-color: #fff;
        }

        button.secondary .spinner {
            border-top-color: #1a237e;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
    </style>
</head>
<body>
    <h3>Worksheet updater</h3>

    <div class="row">
        <select id="method" aria-label="Input method">
            <option value="myDrive">My Drive (filename)</option>
            <option value="gDrive">Google Drive link</option>
            <option value="url">URL (http/https)</option>
        </select>
    </div>

    <div class="row">
        <input id="targetInput" type="text" placeholder="Enter filename, shared Google Drive link, or URL" aria-label="Target file or URL" />
    </div>

    <div class="row controls">
        <button id="refreshBtn" title="Refresh (Ctrl+Enter)">Refresh <span id="refreshSpinner" class="spinner" aria-hidden="true"></span></button>
        <button id="helpBtn" class="secondary">Help</button>
        <button id="closeBtn" class="secondary" aria-label="Close sidebar">Close</button>
    </div>

    <div id="status" class="small note status" aria-live="polite">
        <span class="status__text" id="statusText"></span>
        <button id="statusDetailsLink" class="status__detailsLink" aria-expanded="false">Details</button>
        <button id="statusClose" class="status__close" aria-label="Dismiss status">x</button>
        <button id="retryBtn" style="display:none;">Retry</button>
        <div id="statusDetails" class="status__details" role="region" aria-label="Status details">
            <pre id="statusDetailsText" tabindex="0"></pre>
            <div class="actions">
                <button id="copyDetailsBtn">Copy</button>
                <button id="closeDetailsBtn" class="secondary">Close</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const lsMethod = 'ws_last_method';
            const lsTarget = 'ws_last_target';

            const methodEl = document.getElementById('method');
            const inputEl = document.getElementById('targetInput');
            const statusEl = document.getElementById('status');
            const statusTextEl = document.getElementById('statusText');
            const statusCloseBtn = document.getElementById('statusClose');
            const statusDetailsLink = document.getElementById('statusDetailsLink');
            const statusDetails = document.getElementById('statusDetails');
            const statusDetailsText = document.getElementById('statusDetailsText');
            const copyDetailsBtn = document.getElementById('copyDetailsBtn');
            const closeDetailsBtn = document.getElementById('closeDetailsBtn');
            const retryBtn = document.getElementById('retryBtn');

            const refreshBtn = document.getElementById('refreshBtn');
            const helpBtn = document.getElementById('helpBtn');
            const closeBtn = document.getElementById('closeBtn');
            const spinnerEl = document.getElementById('refreshSpinner');

            const clientLogSampleRate = 0.25;
            const clientLogSeen = new Set();

            let busyCount = 0;
            let lastMethod = '';
            let lastValue = '';

            function maskForLogging(method, value) {
                if (!value) return "";
                try {
                    const v = value.trim();
                    if (method === 'url') {
                        return v.replace(/^(https?:\/\/)(.*)$/, '$1[REDACTED]');
                    }
                    if (method === 'gDrive') {
                        const m = v.match(/\/d\/([-\w]{10,})/) || v.match(/[?&]id=([-\w]{10,})/) || v.match(/([-\w]{25,})/);
                        return m && m[1] ? m[1] : '[REDACTED_DRIVE]';
                    }
                    if (method === 'myDrive') {
                        if (v.length > 120) return v.slice(0, 120) + '...';
                        return v;
                    }
                    return '[REDACTED]';
                } catch (e) {
                    return '[REDACTED]';
                }
            }

            function fingerprintForLogging(operation, message, maskedTarget) {
                const m = (message || '').replace(/\s+/g, ' ').slice(0, 200);
                return operation + '|' + m + '|' + (maskedTarget || '');
            }

            function shouldLogClientError(fingerprint) {
                if (clientLogSeen.has(fingerprint)) return false;
                const roll = Math.random();
                if (roll <= clientLogSampleRate) {
                    clientLogSeen.add(fingerprint);
                    return true;
                }
                clientLogSeen.add(fingerprint);
                return false;
            }

            function setBusy(on) {
                if (on) busyCount++; else busyCount = Math.max(0, busyCount - 1);
                const isBusy = busyCount > 0;
                refreshBtn.disabled = isBusy;
                helpBtn.disabled = isBusy;
                closeBtn.disabled = isBusy;
                spinnerEl.classList.toggle('spinner--visible', isBusy);
            }

            function shouldShowDetails(msg) {
                if (!msg) return false;
                return msg.length > 100 || msg.indexOf('\n') !== -1 || /https?:\/\//.test(msg);
            }

            function showStatus(msg, isError) {
                const safeMsg = msg || '';
                statusTextEl.textContent = safeMsg;
                statusTextEl.title = safeMsg;
                statusDetailsText.textContent = safeMsg;
                statusEl.classList.toggle('status--error', !!isError && !!safeMsg);
                statusEl.classList.toggle('status--ok', !isError && !!safeMsg);
                statusCloseBtn.style.display = safeMsg ? 'inline-block' : 'none';
                const showDetails = shouldShowDetails(safeMsg);
                statusDetailsLink.style.display = showDetails ? 'inline-block' : 'none';
                statusDetailsLink.setAttribute('aria-expanded', 'false');
                statusDetails.style.display = 'none';
            }

            function validate(method, value) {
                if (!value || value.trim() === '') return 'Value is required.';
                if (method === 'url') {
                    try {
                        const u = new URL(value.trim());
                        if (!/^https?:$/i.test(u.protocol)) return 'Only http/https URLs are allowed.';
                    } catch (e) {
                        return 'Invalid URL format.';
                    }
                }
                if (method === 'gDrive') {
                    const v = value.trim();
                    if (!/[-\w]{25,}/.test(v) && !/drive\.google\.com/.test(v)) {
                        return 'Enter a valid Google Drive / Sheet link or ID.';
                    }
                }
                return '';
            }

            function saveLast(method, target) {
                lastMethod = method;
                lastValue = target;
                try {
                    localStorage.setItem(lsMethod, method);
                    localStorage.setItem(lsTarget, target);
                } catch (e) {
                    // ignore storage errors
                }
            }

            function loadLast() {
                try {
                    const m = localStorage.getItem(lsMethod);
                    const t = localStorage.getItem(lsTarget);
                    if (m) methodEl.value = m;
                    if (t) inputEl.value = t;
                } catch (e) { /* ignore */ }
            }

            function extractDriveId(value) {
                if (!value) return '';
                const trimmed = value.trim();
                const byD = trimmed.match(/\/d\/([-\w]{10,})/);
                if (byD && byD[1]) return byD[1];
                const idParam = trimmed.match(/[?&]id=([-\w]{10,})/);
                if (idParam && idParam[1]) return idParam[1];
                const generic = trimmed.match(/([-\w]{25,})/);
                if (generic && generic[1]) return generic[1];
                return '';
            }

            function handleError(err) {
                // Show the backend error message
                showStatus(err.message, true);

                // Highlight input and show retry for file not found
                if (err.code === "file_not_found") {
                    inputEl.classList.add("input-error");
                    retryBtn.style.display = "inline-block";
                    retryBtn.onclick = function () {
                        callServer(lastMethod, lastValue);
                    };
                    statusDetailsText.textContent =
                        "Troubleshooting:\n" +
                        "- Check for typos in the filename or link\n" +
                        "- Ensure the file exists in your Google Drive\n" +
                        "- If using a link, ensure it is a valid Google Drive sharing link";
                } else {
                    inputEl.classList.remove("input-error");
                    retryBtn.style.display = "none";
                }
            }

            function callServer(method, value) {
                setBusy(true);
                showStatus('Sending request...', false);
                saveLast(method, value);

                // --- Timeout logic start ---
                let timedOut = false;
                const timeoutId = setTimeout(() => {
                    timedOut = true;
                    setBusy(false);
                    showStatus('Operation timed out after 30 seconds. Please try again or check your network.', true);
                }, 30000); // 30 seconds
                // --- Timeout logic end ---

                const handlers = {
                    success: function (msg) {
                        if (timedOut) return;
                        clearTimeout(timeoutId);
                        setBusy(false);
                        inputEl.classList.remove("input-error");
                        retryBtn.style.display = "none";
                        showStatus(msg || 'Done', false);
                    },
                    failure: function (err) {
                        if (timedOut) return;
                        clearTimeout(timeoutId);
                        setBusy(false);
                        handleError(err);

                        // Logging (unchanged)
                        try {
                            const errStack = (err && err.stack) ? err.stack : (err && err.toString ? err.toString() : String(err));
                            const masked = maskForLogging(method, value);
                            const fingerprint = fingerprintForLogging(method, err.message || err.toString(), masked);

                            if (shouldLogClientError(fingerprint)) {
                                const scriptRun = window.google && window.google.script && window.google.script.run;
                                if (scriptRun && typeof scriptRun.reportError === "function") {
                                    try {
                                        scriptRun
                                            .withFailureHandler(function () { /* swallow logging failures */ })
                                            .reportError(err.message || err.toString(), method, errStack);
                                    } catch (e) {
                                        // ignore if google.script.run not present
                                    }
                                }
                            }
                        } catch (e) {
                            // Defensive: never surface logging errors to user
                        }
                    }
                };

                const scriptRun = window.google && window.google.script && window.google.script.run;

                if (method === 'myDrive') {
                    scriptRun
                        .withSuccessHandler(handlers.success)
                        .withFailureHandler(handlers.failure)
                        .importRidersFrommyDrive(value.trim());
                } else if (method === 'gDrive') {
                    scriptRun
                        .withSuccessHandler(handlers.success)
                        .withFailureHandler(handlers.failure)
                        .importRidersFromGoogleDriveLink(value.trim());
                } else if (method === 'url') {
                    scriptRun
                        .withSuccessHandler(handlers.success)
                        .withFailureHandler(handlers.failure)
                        .importRidersFromUrl(value.trim());
                } else {
                    clearTimeout(timeoutId);
                    setBusy(false);
                    showStatus('Unknown method', true);
                }
            }

            inputEl.addEventListener('paste', function () {
                setTimeout(() => {
                    const val = inputEl.value || '';
                    if (/drive\.google\.com|docs\.google\.com|spreadsheets\.google\.com/i.test(val)) {
                        const id = extractDriveId(val);
                        if (id) {
                            methodEl.value = 'gDrive';
                            inputEl.value = id;
                            showStatus('Detected Drive link; extracted ID.', false);
                        }
                    }
                }, 50);
            });

            refreshBtn.addEventListener('click', function () {
                const method = methodEl.value;
                const value = inputEl.value || '';
                const err = validate(method, value);
                if (err) {
                    showStatus(err, true);
                    return;
                }
                callServer(method, value);
            });

            helpBtn.addEventListener('click', function () {
                const scriptRun = window.google && window.google.script && window.google.script.run;
                if (scriptRun && typeof scriptRun.showHelpDocument === "function") {
                    scriptRun.showHelpDocument();
                }
            });

            closeBtn.addEventListener('click', function () {
                if (busyCount > 0) {
                    showStatus('Operation in progress - please wait.', true);
                    return;
                }
                if (window.google && window.google.script && window.google.script.host) {
                    window.google.script.host.close();
                }
            });

            statusCloseBtn.addEventListener('click', function () {
                showStatus('', false);
                inputEl.classList.remove("input-error");
                retryBtn.style.display = "none";
            });

            statusDetailsLink.addEventListener('click', function () {
                const expanded = statusDetails.style.display === 'flex';
                if (expanded) {
                    statusDetails.style.display = 'none';
                    statusDetailsLink.setAttribute('aria-expanded', 'false');
                } else {
                    statusDetails.style.display = 'flex';
                    statusDetailsLink.setAttribute('aria-expanded', 'true');
                    statusDetailsText.focus();
                }
            });

            closeDetailsBtn.addEventListener('click', function () {
                statusDetails.style.display = 'none';
                statusDetailsLink.setAttribute('aria-expanded', 'false');
            });

            copyDetailsBtn.addEventListener('click', function () {
                const text = statusDetailsText.textContent || '';
                if (!text) {
                    showStatus('Nothing to copy', true);
                    return;
                }

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => {
                        showStatus('Copied to clipboard', false);
                    }).catch(() => {
                        fallbackCopy(text);
                    });
                } else {
                    fallbackCopy(text);
                }

                function fallbackCopy(t) {
                    try {
                        const ta = document.createElement('textarea');
                        ta.value = t;
                        ta.style.position = 'fixed';
                        ta.style.left = '-9999px';
                        document.body.appendChild(ta);
                        ta.select();
                        const ok = document.execCommand('copy');
                        document.body.removeChild(ta);
                        if (ok) showStatus('Copied to clipboard', false);
                        else showStatus('Copy failed', true);
                    } catch (e) {
                        showStatus('Copy failed', true);
                    }
                }
            });

            inputEl.addEventListener('keydown', function (ev) {
                if (ev.key === 'Enter' && (ev.ctrlKey || ev.metaKey)) {
                    ev.preventDefault();
                    refreshBtn.click();
                } else if (ev.key === 'Escape') {
                    ev.preventDefault();
                    if (ev.shiftKey) {
                        closeBtn.click();
                    } else {
                        showStatus('', false);
                        inputEl.classList.remove("input-error");
                        retryBtn.style.display = "none";
                    }
                }
            });

            loadLast();
            inputEl.focus();
            setBusy(false);
            showStatus('', false);

        })();
    </script>
</body>
</html>